function closeBookCategory(e,t){e&&($(".channel .opt").removeClass("radio_checked"),e.addClass("radio_checked"),$("#channelVal").val(parseFloat(t)));var a=$("#channelVal").val();$(".city li").each(function(){$(this).attr("data-parentid")==a?$(this).removeClass("hidden"):$(this).addClass("hidden")}),6006!=t&&($(".city .ctem").attr("data-id",""),$(".city .ctem").text("请选择"),$(".district .ctem").attr("data-id",""),$(".district .ctem").text("请选择")),$(".district li").remove()}function popup_common(e,t){t?($(".confirm,.cancel").css("display","inline-block"),$(".sure_btn").hide()):($(".confirm,.cancel").hide(),$(".sure_btn").css("display","inline-block")),$(".popup_box p").text(e);var a=$(".popup_box").height();$(".popup_box").css({"margin-top":-a/2,"z-index":"101"}),$(".boxshadow_bg").removeClass("hidden"),$(".popup_box").addClass("opacity")}function toast(e,t){t?$(".submitted i").addClass(t).show():$(".submitted i").removeClass().hide(),$(".submitted span").text(e),$(".submitted").removeClass("hidden"),setTimeout(function(){$(".submitted i").removeClass().hide(),$(".submitted").addClass("hidden")},2e3)}$("img[data-src]").lazyloads();var kind=$(".prompt"),content=$("#content"),isOk=!0,isResubmit=!0,isDel,isSomeEdit;closeBookCategory(!1,6006),isDel=$("#removeBtn").length>0,content.on("click",".popup_close,.popup_box .cancel,.popup_box .sure_btn",function(){$(".popup_box").css({"z-index":"-1"}),$(".boxshadow_bg").addClass("hidden"),$(".popup_box").removeClass("opacity")}).on("click",".classify .city li",function(){var e=$(this).attr("data-id");$.ajax({url:"/author/get-bookCategory",type:"post",data:{parentId:e},dataType:"json",cache:!1,timeout:5e3,success:function(e){if(1==e.status){for(var t="",a=0;a<e.result.length;a++){var s='<li data-id="'+e.result[a].id+'"><em>'+e.result[a].name+"</em></li>";t+=s}$(".district ul").html(t),$(".district span").html('<em class="ctem" data-id="'+e.result[0].id+'">'+e.result[0].name+"</em><i></i>"),$(".classify .hint").removeClass("hidden").addClass("right").html("<i></i>")}},error:function(){}})}).on("click",".classify .district li",function(){var e=$(this).attr("data-id"),t=$(this).children("em").text();$(".district .ctem").html(t).attr("data-id",e),$(".district ul").addClass("hidden"),$(".classify .hint").removeClass("hidden").addClass("right").html("<i></i>")}).on("click",".xgTag .tagIntro",function(e){var t=$(".channel .radio_checked").data("id"),a=!$(".channel .opt").hasClass("radio_checked");if(obj=$(e.srcElement||e.target),$(obj).is("span")||$(obj).is("i")){var s=$(obj);if(s.is("i")){var i=s.parent().attr("data-key");s.parent().remove()}else{var i=s.attr("data-key");s.remove()}$(".scroll ul li[data-key="+i+"]").removeClass("current");var d=$(".tagIntro .append").length;return checkTag(d),!1}if(a)return $(".channel .hint").removeClass("hidden right").addClass("wrong").html("<i></i>请选择作品所属频道"),!1;$(".popup").removeClass("hidden");for(var o=0;o<$(".tagCon .scroll").length;o++){var n=$(".tagCon .scroll").eq(o).data("id");t==n&&($(".tagCon .scroll").addClass("hidden"),$(".tagCon .scroll").eq(o).removeClass("hidden"))}}).on("click",".shoufa .opt",function(){$(".shoufa .opt").removeClass("radio_checked"),$(this).addClass("radio_checked"),$(this).hasClass("sfTadu")?$("#sfhd").val("T"):$("#sfhd").val("Z")}).on("click",".zw_box i",function(){$(this).toggleClass("check_on")}).on("click","#submit",function(){if(!isResubmit)return!1;var e=!!$(".zw_box i").hasClass("check_on"),t=$("#textarea").val(),a=t.length,s=$("#channelVal").val(),i=$("#bookName").val(),d=$(".classify .city .ctem").attr("data-id"),o=$(".classify .district .ctem").attr("data-id"),n=$("#sfhd").val();if(!(checkbName(i)&&checkGender(s)&&checkClassify(d,o)&&checkShoufa(n)&&checkBtext(t,a)))return!1;isResubmit=!1;for(var c=$(".xgTag .tagIntro .append"),r="",l=0;l<c.length;l++){var p=$(c[l]).attr("data-key");r+=" "+p}var h=new FormData,m=document.getElementById("file").files;h.append("title",i),h.append("intro",t),h.append("tags",$.trim(r)),h.append("startStatus",n),h.append("categoryId",d),h.append("categoryNextId",o),h.append("competition",e),m&&h.append("file",m[0]),$.ajax({url:"/author/create-bookinfo",type:"post",data:h,async:!1,dataType:"json",processData:!1,contentType:!1,success:function(e){1!=e.status?popup_common(e.message):($(".cj_box").addClass("hidden"),$(".cj_succBox").removeClass("hidden"),$(".zpTitle .t").removeClass("sp"),$("#to_drafts_btn").attr("href","/author/to-drafts?bookId="+e.result))}}),isResubmit=!0}).on("click",".pdctNow .certificate span",function(){var e=$(this).siblings("ul"),t=e.hasClass("hidden"),a=$(this).children(".ctem").text(),s=e.children("li");t?($(".certificate ul").addClass("hidden"),e.removeClass("hidden")):e.addClass("hidden");for(var i=0;i<s.length;i++){var d=$(s[i]).children("em").text();a==d&&(s.css("background","#fcfcfc"),$(s[i]).css("background","#efefef"))}}).on("click",".pdctNow .certificate li",function(){var e=$(this).attr("data-id");ct_p=$(this).children("em").text(),newDt=$(this).parent("ul").siblings("span").children(".ctem").text(),$(this).parent("ul").siblings("span").children("em").html(ct_p).attr("data-id",e),$(this).parent("ul").addClass("hidden");var t=$("#newChapter"),a=$(".part");t.length>0&&a.length>0&&(a.removeClass("partOpen"),$(".part[data-id='"+e+"']").addClass("partOpen"))}).on("click","#revise",function(){1==parseInt($(this).data("type"))?($(".all_alter").removeClass("hidden"),$(".all_preview").addClass("hidden"),$("#submitBtn,#cantelBtn").removeClass("hidden"),$("#revise").addClass("hidden"),$(".upload_btn").removeClass("hidden"),isSomeEdit=1):2==parseInt($(this).data("type"))?($(".part_alter").removeClass("hidden"),$(".part_preview").addClass("hidden"),$("#submitBtn,#cantelBtn").removeClass("hidden"),$("#revise").addClass("hidden"),$(".upload_btn").removeClass("hidden"),isSomeEdit=2):3==parseInt($(this).data("type"))?toast("下架书籍，限制修改"):4==parseInt($(this).data("type"))?toast("签约书籍，限制修改"):5==parseInt($(this).data("type"))?toast("解约书籍，限制修改"):6==parseInt($(this).data("type"))?($(".part_preview").addClass("hidden"),$(".all_preview").addClass("hidden"),$("#bookName").removeClass("hidden"),$(".category").removeClass("hidden"),$(".cfIn").removeClass("hidden"),$(".mrTag").removeClass("hidden"),$(".sf_type").removeClass("hidden"),$(".mtext").removeClass("hidden"),$("#submitBtn,#cantelBtn").removeClass("hidden"),$("#revise").addClass("hidden"),$(".upload_btn").removeClass("hidden"),isSomeEdit=2):toast("暂时不提供修改,请联系责编"),$("#textarea").val($(".synopsis").text()),isDel&&$("#removeBtn").addClass("hidden")}).on("click","#cantelBtn",function(){if($(".xgTag .tagIntro").html($(".mrTag .tagIntro").html()),$(".xgTag .tagIntro span").each(function(){$(this).append("<i></i>")}),"1"==$(this).data("type")){$(".all_alter").addClass("hidden"),$(".all_preview").removeClass("hidden"),$(".shoufa .opt,.channel .opt").removeClass("radio_checked"),"塔读首发"==$(".sf_type").text()?($(".sfTadu").addClass("radio_checked"),$("#sfhd").val("T")):($(".sfEditor").addClass("radio_checked"),$("#sfhd").val("Z"));for(var e=0;e<$(".channel .opt").length;e++){var t=$(".channel .opt").eq(e).data("id");$(".channel .category").data("id")==t&&closeBookCategory($(".category[data-id="+t+"]"),t)}$("#textarea").val($(".synopsis").text())}else $(".part_alter").addClass("hidden"),$(".part_preview").removeClass("hidden");$("#submitBtn,#cantelBtn,.block .hint").addClass("hidden"),$("#revise").removeClass("hidden"),$(".upload_btn").addClass("hidden"),isDel&&$("#removeBtn").removeClass("hidden")}).on("click","#submitBtn",function(){if(!isOk)return!1;var e=!!$(".zw_box i").hasClass("check_on"),t=$("#textarea").val(),a=t.length,s=$("#channelVal").val(),i=$("#bookName").val(),d=$(".classify .city .ctem").attr("data-id"),o=$(".classify .district .ctem").attr("data-id"),n=$("#sfhd").val(),c=$("#bookId").val();if(1==isSomeEdit){var r=$("#bookName2").val();if(r!=i&&!checkbName(i))return!1;if(!(checkGender(s)&&checkClassify(d,o)&&checkShoufa(n)&&checkBtext(t,a)))return!1}else if(!checkBtext(t,a))return!1;isResubmit=!1;for(var l=$(".xgTag .tagIntro .append"),p="",h=0;h<l.length;h++){var m=$(l[h]).attr("data-key");p+=" "+m}var u=new FormData,v=document.getElementById("file").files;u.append("title",i),u.append("intro",t),u.append("tags",$.trim(p)),u.append("startStatus",n),u.append("categoryId",d),u.append("categoryNextId",o),u.append("competition",e),u.append("id",c),u.append("authorId",isSomeEdit),v&&u.append("file",v[0]);var f=$(".synopsis").text();t!=f&&u.append("isChangeIntro",1),1==isSomeEdit?($.ajax({url:"/author/update-bookinfo",type:"post",data:u,async:!1,dataType:"json",processData:!1,contentType:!1,success:function(e){1!=e.status?popup_common(e.message):(toast("修改成功","success"),setTimeout(function(){window.location.reload()},2e3))}}),isOk=!0):($.ajax({url:"/author/update-some-bookinfo",type:"post",data:u,async:!1,dataType:"json",processData:!1,contentType:!1,success:function(e){1!=e.status?popup_common(e.message):(toast("修改成功","success"),setTimeout(function(){window.location.reload()},2e3))}}),isOk=!0)}).on("click",".channel .opt",function(){var e,t=$(this),e=t.data("id");closeBookCategory(t,e)}).on("click","#removeBtn",function(){popup_common("删除后，所有内容都将清除不可恢复，确定删除吗？",!0)}).on("click",".popup_box .confirm",function(){var e=$("#removeBtn").attr("data-id");$.ajax({url:"/author/delete",type:"post",data:{bookId:e},async:!1,dataType:"json",success:function(e){1==e.status?($(".popup_box").css({"z-index":"-1"}),$(".boxshadow_bg").addClass("hidden"),$(".popup_box").removeClass("opacity"),toast("删除成功","success"),setTimeout(function(){window.location.href="/author/to-workmanagement"},3e3)):($(".popup_box").css({"z-index":"-1"}),$(".boxshadow_bg").addClass("hidden"),$(".popup_box").removeClass("opacity"),toast(e.message,"success"),setTimeout(function(){window.location.reload()},3e3))}})});