/*********** ---------------------------------------------|
 \\\//////  http://www.zhangyongfeng.com/                |
 | @   @ |  ---------------------------------------------|
 |   L   |  Zhang Yongfeng <artwc@outlook.com>           |
 (   v   )  Created by 2019/1/10                           |
 \_____/   _____________________________________________|
 * @license GPL
 * @version 1.0.0
 * @fileOverview for .html
 */
var booklistRender,bookId=Number(k.getUrl("bookid")),chapterId=Number(k.getUrl("chapterid")),chapterStatus=null,isVip=!1,isSigning=!1,volumeId=0,booklistData={},bookInfo={},ChapterEditRender=k(".ChapterEdit .cont"),timingPublishDates=[],timingPublishDateForCurrent=null,exitCheck=!1;function setTextCount(t,n){t.innerText=k.getTextCount(n),exitCheck=!0}function removeChapter(t){(t=t||chapterId)>0?k.alert({text:"是否删除本章节至垃圾箱中?",type:"failed",only:!0,confirmText:"确认删除",confirm:function(){k.api("/ck/author/book/"+bookId+"/draft/chapter/"+t).delete().send((function(){timingPublishDateForCurrent&&(timingPublishDates=timingPublishDates.filter((function(t){return new Date(timingPublishDateForCurrent).getTime()!==t}))),newChapter(t),k.alert({type:"success",text:"删除成功",timeout:1})}),(function(t){k.alert({text:t.msg,cancelText:"我知道了",cancel:function(){}})}))},cancelText:"我再想想",cancel:function(){}}):k.alert({text:"请选择要删除的章节。",type:"failed",only:!0})}function fullscreen(){k.fullscreen(".chapterInput",(function(){k("#chapterContentInput").style({"min-height":"75vh"})}),(function(){k("#chapterContentInput").rmStyle("min-height")}))}function SaveChapter(t){if(!SaveChapter.isRun){SaveChapter.isRun=!0,setTimeout((function(){SaveChapter.isRun=!1}),500);var n={volumeId:window.volume.value,oldVolumeId:volumeId,isVip:window.chapterType.value,name:k.trim(window.titleContentInput.value.replace(/\s\u3000+/g," ")),content:k.json.stringify([{textType:"simple",text:window.chapterContentInput.value.replace(/^[\s\u3000]+/gm,"")}]),authorSpeak:window.authorSpeak.value};if(""===n.name)return k.alert({text:"请给章节起个名字",type:"failed",onclose:function(){window.titleContentInput.focus()}});if(n.name.match(/[_]/))return k.alert({text:"章节名不能包含特殊符号",type:"failed",onclose:function(){window.titleContentInput.focus()}});if(window.titleCount.innerText>20)return k.alert({text:"章节名不能超过20个字",type:"failed",onclose:function(){window.titleContentInput.focus()}});if(""===window.chapterContentInput.value.trim())return k.alert({text:"还没有写章节内容",type:"failed",onclose:function(){window.chapterContentInput.focus()}});if(window.contentCount.innerText>2e4)return k.alert({text:"不能保存, 章节内容不能超过20000字",type:"failed",confirmText:"我知道了",confirm:function(){window.chapterContentInput.focus()}});if(void 0===t&&(window.saveInfo.style.display="block"),2===t)var e=k.alert({type:"none",title:"发布章节",only:!0,text:'<div class="pushChapterPop"><h1>发布章节</h1><hr><span class="gray">章节名: </span>'+n.name+'<br><span class="gray">字数: </span>'+window.contentCount.innerText+'字<br><span class="gray">类型: </span>'+window.chapterType.options[window.chapterType.selectedIndex].text+'<br><span class="gray">发布卷: </span>'+window.volume.options[window.volume.selectedIndex].text+'<div id="timingPublish"><hr><label for="timingPublishCheckbox"><input id="timingPublishCheckbox" type="checkbox" '+(timingPublishDateForCurrent?"checked":"")+'>定时发布: </label><input id="timingPublishDate" type="text" readonly><br><label class="info">设置较晚的时间定时发布生效, 否则将直接发布</label></div></div>',onopen:function(){var t;[-1,1,2].indexOf(chapterStatus)>=0&&(window.timingPublish.style.display="none"),laydate.render({elem:"#timingPublishDate",type:"datetime",format:"yyyy-MM-dd HH:mm:ss",min:(new Date).getTime(),max:100,trigger:"click",value:(t=timingPublishDateForCurrent?new Date(timingPublishDateForCurrent.replace(/-/g,"/")):new Date,(t=new Date(t.getTime()+18e5)).setSeconds(0),t),btns:["clear","confirm"],position:"fixed",zIndex:2147483647})},confirm:function(){var t=window.timingPublishDate.value.replace(/\-/g,"/");if(new Date(t).getTime()>(new Date).getTime()&&window.timingPublishCheckbox.checked){n.timingPublishDate=t.replace(/\//g,"-");for(var o,i=0;o=timingPublishDates[i];i++)if(o===new Date(t).getTime())return k(".pushChapterPop label.info").html("同一作品的不同章节 不可以设置同样的时间定时发布哦"),!0}else delete n.timingPublishDate;chapterId&&(n.id=chapterId),k.api("/ck/book/black-word/check").post({chapterName:n.name,authorSpeaking:n.authorSpeak,chapterContent:n.content}).send((function(t){function o(t,n){e.close(),k.alert({text:'<div class="BlackWord_pop"><h2>'+t+"：</h2>"+n.map((function(t){return"<span>"+t+"</span>"})).join("")+"</div>",type:"none",confirmText:"我知道了",confirm:function(){}})}t.chapterName.length>0?o("章节标题存在黑词",t.chapterName):t.chapterContent.length>=5?o("章节内容存在黑词",t.chapterContent):t.authorSpeaking.length>0?o("作者有话说存在黑词",t.authorSpeaking):k.api("/ck/author/book/"+bookId+"/draft/publish").post(n).send((function(t){if(exitCheck=!1,t.timingPublishDate){if(timingPublishDateForCurrent=t.timingPublishDate,timingPublishDates.push(new Date(t.timingPublishDate).getTime()),chapterId)for(var e,o=0;e=booklistData.chapterList[o];o++)e.chapterId===chapterId&&(booklistData.chapterList[o].isTiming=!0,booklistData.chapterList[o].updateTime=n.timingPublishDate,booklistData.chapterList[o].wordCount=window.contentCount.innerText);else chapterId=t.id,booklistData.chapterList[0]={chapterName:t.name,isTiming:!0,updateTime:t.timingPublishDate,wordCount:window.contentCount.innerText,chapterId:t.id,bookId:bookId};updateChapterList()}k.alert({text:t.timingPublishDate?"本章将在"+k.date(t.timingPublishDate).ago()+"发布":"发布成功!",type:"success",confirmText:"再写一章",confirm:function(){newChapter(t.timingPublishDate?0:chapterId)},cancelText:t.timingPublishDate?"留在本章":"查看发布章节",cancel:function(){t.timingPublishDate||(location.href="published.html?bookid="+bookId+"&chapterid="+t.id)}})}),(function(t){if(1242===t.code){var n=t.msg.split("：");k.alert({text:'<div class="BlackWord_pop"><h2>'+n[0]+"</h2>"+n[1].replace(/\[|\]/g,"").split(",").map((function(t){return"<span>"+t+"</span>"})).join("")+"</div>",type:"none",confirmText:"我知道了",confirm:function(){}})}else k.alert({text:t.msg,type:"failed",cancelText:"我知道了",cancel:function(){}})}))}))},confirmText:"确认发布",cancelText:"取消",cancel:function(){}});else{var o=document.title;document.title="保存中..."+o,timingPublishDateForCurrent&&(n.timingPublishDate=timingPublishDateForCurrent),chapterId&&(n.id=chapterId),k.api("/ck/author/book/"+bookId+"/draft").post(n).send((function(n){if(document.title=o,1===t?k.alert({text:"保存成功",type:"success",timeout:1,onclose:function(){}}):window.saveInfo.style.display="none",chapterId)for(var e,i=0;e=booklistData.chapterList[i];i++)e.chapterId===n.id&&(e.chapterName=n.name,e.updateTime=k.date().format(),e.wordCount=window.contentCount.innerText);else chapterId=n.id,booklistData.chapterList[0]={chapterName:n.name,isTiming:!1,updateTime:k.date().format(),wordCount:window.contentCount.innerText,chapterId:n.id,bookId:bookId};updateChapterList()}),(function(t){k.alert({text:t.msg,type:"failed"}),document.title="保存失败"+o}))}}}function loadChapterContext(t,n){"0"!==n?(ChapterEditRender.cleanRender(),k.api("/ck/author/book/"+t+"/draft/show").get({id:n,isFilterBlackWords:0}).send((function(t){chapterId=t.id,volumeId=t.volumeId,chapterStatus=Number(t.status.id),timingPublishDateForCurrent=k.date(t.timingPublishDate).format(),ChapterEditRender.updateRender({chapterName:t.name,chapterContent:k.map(t.content,(function(t){if("simple"===t.textType)return t.text.replace(/^[\s\u3000]*/gm,"\n　　")})).join("\n"),authorSpeak:t.authorSpeaking||""});var n=window.volume,e=window.chapterType;k.forEach(n.options,(function(n){n.value===String(t.volumeId)&&(n.defaultSelected=!0)})),n.disabled=!!t.isUpdate.id,e.disabled=!!t.isUpdate.id,k.api("/ck/author/book/"+bookId).get().send((function(n){4===n.authLevel.id&&1===n.isVIP.id?(isVip=!0,e[t.isVIP.id].selected=!0):e.options.length=1})),updateChapterList()}),(function(t){k.alert({text:t.msg,type:"failed",onclose:function(){}})}))):newChapter()}function newChapter(t){setTimeout((function(){var t=booklistData.chapterList.filter((function(t){return t.isTiming})).sort((function(t,n){return new Date(n.updateTime).getTime()-new Date(t.updateTime).getTime()}));t[0]?document.querySelector(".tips").textContent="最新定时发布章节："+t[0].chapterName:bookInfo.lastUpdateChapter&&(document.querySelector(".tips").textContent="最新已发布章节："+bookInfo.lastUpdateChapter.name)}),1e3),ChapterEditRender.updateRender({chapterName:"",chapterContent:"",authorSpeak:""}),window.chapterType.options[Number(isVip)].selected=!0,booklistData.chapterList=booklistData.chapterList.filter((function(n){return!(n.chapterId===t||0===n.chapterId)})),booklistData.chapterList.unshift({chapterName:"未命名章节",className:"now",isTiming:!1,updateTime:null,wordCount:0,chapterId:0,bookId:bookId}),chapterId=0,chapterStatus=null,timingPublishDateForCurrent="",updateChapterList()}function updateChapterList(){booklistData.chapterList.forEach((function(t,n){t.chapterId===chapterId?(booklistData.chapterList[n].className="now",timingPublishDateForCurrent&&(booklistData.chapterList[n].updateTime=timingPublishDateForCurrent,booklistData.chapterList[n].isTiming=!0)):booklistData.chapterList[n].className=""})),booklistData.chapterCount=booklistData.chapterList.length,booklistRender.updateRender(booklistData),exitCheck=!1}function formatContent(){var t=k("#chapterContentInput").item(0);t.value=t.value.replace(/[\s\u3000]*\n/g,"\n").replace(/[\s\u3000]*(.*)/g,"　　$1\n")}window.onbeforeunload=function(t){exitCheck&&((t=window.event||t).returnValue="确定离开当前页面吗？")},k.login((function(){k.api("/ck/author/book/"+bookId+"/draft").get({num:1e3}).send((function(t,n){k.save("nowUserPop")||0===t.length&&0===n.totalNum&&k.api("/ck/author/book").get({num:0}).send((function(t,n){if(1===n.totalNum&&!t.wordCount)var e,o,i=k("<div>").className("NewUser").style({height:document.body.scrollHeight+"px"}).append(k("<img>").add({src:"//static.17k.com/author/skin/img/new/skip.png",srcset:"//static.17k.com/author/skin/img/new/skip@2x.png 2x"}).className("skip").event("click",(function(){i.remove(),k.save("nowUserPop",1)})).item()).append(k("<img>").add({src:"//static.17k.com/author/skin/img/new/1.png",srcset:"//static.17k.com/author/skin/img/new/1@2x.png 2x"}).className("setp1").event("click",(function(){this.style.display="none",e.style.display="block",setTimeout((function(){e.style.opacity=1})),k.scrollTo(e,-200)})).item()).append(e=k("<img>").add({src:"//static.17k.com/author/skin/img/new/2.png",srcset:"//static.17k.com/author/skin/img/new/2@2x.png 2x"}).className("setp2").event("click",(function(){this.style.display="none",o.style.display="block",setTimeout((function(){o.style.opacity=1})),k.scrollTo(o,-200)})).item()).append(o=k("<img>").add({src:"//static.17k.com/author/skin/img/new/3.png",srcset:"//static.17k.com/author/skin/img/new/3@2x.png 2x"}).className("setp3").event("click",(function(){i.remove(),k.save("nowUserPop",1)})).item()).appendTo(document.body)})),booklistData.chapterList=k.map(t||[],(function(t){return t.timingPublishDate&&timingPublishDates.push(t.timingPublishDate),{chapterName:t.chapterName,isTiming:!!t.timingPublishDate,updateTime:k.date(t.timingPublishDate||t.updateTime).format(),wordCount:t.wordcount,chapterId:t.chapterId,vip:t.isVip.id?"vip":"",bookId:bookId}})),booklistData.chapterCount=n.totalNum;var e={bookId:bookId,bookName:"未命名书籍",draft:"now"},o=k(".Tabbox").render(e);k.api("/ck/author/book/"+bookId).get().send((function(t){bookInfo=t,o.updateRender({bookName:t.bookName}),(isSigning=4===t.authLevel.id)&&1===t.isVIP.id?(isVip=!0,window.chapterType[1].selected=!0):window.chapterType.options.length=1})),booklistRender=k(".ChapterEdit .list").render(booklistData),k.api("/ck/author/book/"+bookId+"/volume").get().send((function(t){var n=[];t.forEach((function(t){0===t.type.id&&n.push({id:t.volumeId,name:t.name})})),ChapterEditRender.render({volumes:n},(function(){var t=k("#chapterContentInput").event("paste",(function(){var t=this;setTimeout((function(){t.value=t.value.replace(/[\s\u3000]*\n/g,"\n").replace(/[\s\u3000]*(.*)/g,"　　$1\n")}))})).event("input",(function(){setTextCount(window.contentCount,this.value)}));window.contentCount.innerText=t.get("value").replace(/[\s\u3000]+/g,"").length;k("#titleContentInput").event("input",(function(){setTextCount(window.titleCount,this.value)}));var n=k("#authorSpeak").event("input",(function(){setTextCount(window.authorSpeakCount,this.value)}));window.authorSpeakCount.innerText=n.get("value").replace(/[\s\u3000]+/g,"").length;var e=window.volume;e[e.length-3].selected=!0})),chapterId?loadChapterContext(bookId,chapterId):newChapter()}))}),(function(t){k.alert({text:t.msg,onclose:function(){location.replace("/manage/")}})}))})),setInterval(SaveChapter,18e4);
